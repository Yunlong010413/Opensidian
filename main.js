"use strict";var xe=Object.create;var F=Object.defineProperty;var Ee=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var we=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var Te=(a,e)=>{for(var t in e)F(a,t,{get:e[t],enumerable:!0})},oe=(a,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ce(e))!be.call(a,s)&&s!==t&&F(a,s,{get:()=>e[s],enumerable:!(i=Ee(e,s))||i.enumerable});return a};var W=(a,e,t)=>(t=a!=null?xe(we(a)):{},oe(e||!a||!a.__esModule?F(t,"default",{value:a,enumerable:!0}):t,a)),Me=a=>oe(F({},"__esModule",{value:!0}),a);var ke={};Te(ke,{default:()=>z});module.exports=Me(ke);var fe=require("obsidian");var w=require("obsidian");var U=require("obsidian");var re=[{value:"haiku",label:"Claude Haiku",description:"Fast and efficient"},{value:"sonnet",label:"Claude Sonnet",description:"Balanced performance"},{value:"opus",label:"Claude Opus",description:"Most capable"}],Q=[{value:"gpt-5",label:"GPT-5",description:"Latest GPT-5"},{value:"gpt-5-2025-08-07",label:"GPT-5 (2025-08-07)",description:"Dated version"},{value:"gpt-5-codex",label:"GPT-5 Codex",description:"Code-focused"},{value:"gpt-5.1-codex",label:"GPT-5.1 Codex",description:"Improved Codex"},{value:"gpt-5.1-codex-max",label:"GPT-5.1 Codex Max",description:"Large Codex"},{value:"gpt-5.1-codex-mini",label:"GPT-5.1 Codex Mini",description:"Small Codex"},{value:"gpt-5.2",label:"GPT-5.2",description:"Latest 5.2"},{value:"gpt-4o",label:"GPT-4o",description:"Multimodal"},{value:"gpt-4-turbo",label:"GPT-4 Turbo",description:"Fast GPT-4"}];function le(a){return Q.some(e=>e.value===a)}function ce(a,e){return e==="anthropic"&&{haiku:"claude-haiku-4-5",sonnet:"claude-sonnet-4-5",opus:"claude-opus-4-5-20251101"}[a]||a}var pe=[{value:"off",label:"Off",tokens:0},{value:"low",label:"Low",tokens:1024},{value:"medium",label:"Med",tokens:4096},{value:"high",label:"High",tokens:16384},{value:"max",label:"Max",tokens:32768}],Ae=[{value:"qwen-turbo",label:"Qwen Turbo",description:"Fast responses"},{value:"qwen-plus",label:"Qwen Plus",description:"Balanced"},{value:"qwen-max",label:"Qwen Max",description:"Most capable"}],Y=class{constructor(e,t,i){this.buttonEl=null;this.dropdownEl=null;this.plugin=t,this.onModelChange=i,this.container=e.createDiv({cls:"claudian-model-selector"}),this.render()}getAvailableModels(){let e=this.plugin.settings.providerType,t=[],i="";e==="anthropic"?(t=[...re],i=this.plugin.settings.customAnthropicModels):e==="openai"?(t=[...Q],i=this.plugin.settings.customOpenAIModels):(t=[...Ae],i=this.plugin.settings.customAliyunModels);let s=(i||"").split(/[,\n]/).map(o=>o.trim()).filter(o=>o.length>0).map(o=>({value:o,label:o,description:"Custom Model"})),n=new Set(t.map(o=>o.value)),r=s.filter(o=>!n.has(o.value));return[...t,...r]}async validateCurrentModel(){let e=this.plugin.settings.providerType,t=this.plugin.settings.modelType,i=this.getAvailableModels();if(!i.some(n=>n.value===t)&&i.length>0){let n=i[0].value;console.log(`[Opensidian] Model ${t} invalid for provider ${e}. Switching to ${n}`),this.plugin.settings.modelType=n,await this.plugin.saveSettings(),this.updateDisplay(),this.onModelChange()}}render(){this.container.empty(),this.buttonEl=this.container.createDiv({cls:"claudian-model-btn"}),this.updateDisplay(),this.dropdownEl=this.container.createDiv({cls:"claudian-model-dropdown"}),this.renderOptions()}updateDisplay(){if(!this.buttonEl)return;let e=this.plugin.settings.modelType,i=this.getAvailableModels().find(n=>n.value===e);this.buttonEl.empty(),this.buttonEl.createSpan({cls:"claudian-model-label"}).setText((i==null?void 0:i.label)||e)}renderOptions(){if(!this.dropdownEl)return;this.dropdownEl.empty();let e=this.plugin.settings.modelType,t=this.getAvailableModels();for(let i of t){let s=this.dropdownEl.createDiv({cls:"claudian-model-option"});i.value===e&&s.addClass("selected"),s.createSpan({text:i.label}),i.description&&s.setAttribute("title",i.description),s.addEventListener("click",async n=>{n.stopPropagation(),this.plugin.settings.modelType=i.value,await this.plugin.saveSettings(),this.updateDisplay(),this.renderOptions(),this.onModelChange()})}}},J=class{constructor(e,t){this.gearsEl=null;this.plugin=t,this.container=e.createDiv({cls:"claudian-thinking-selector"}),this.render()}render(){this.container.empty(),this.container.createSpan({cls:"claudian-thinking-label-text"}).setText("Thinking:"),this.gearsEl=this.container.createDiv({cls:"claudian-thinking-gears"}),this.renderGears()}renderGears(){if(!this.gearsEl)return;this.gearsEl.empty();let e=this.plugin.settings.thinkingBudget,t=pe.find(n=>n.value===e);this.gearsEl.createDiv({cls:"claudian-thinking-current"}).setText((t==null?void 0:t.label)||"Off");let s=this.gearsEl.createDiv({cls:"claudian-thinking-options"});for(let n of[...pe].reverse()){let r=s.createDiv({cls:"claudian-thinking-gear"});r.setText(n.label),r.setAttribute("title",n.tokens>0?`${n.tokens.toLocaleString()} tokens`:"Disabled"),n.value===e&&r.addClass("selected"),r.addEventListener("click",async o=>{o.stopPropagation(),this.plugin.settings.thinkingBudget=n.value,await this.plugin.saveSettings(),this.updateDisplay()})}}updateDisplay(){this.renderGears()}},X=class{constructor(e,t){this.toggleEl=null;this.labelEl=null;this.plugin=t,this.container=e.createDiv({cls:"claudian-permission-toggle"}),this.render()}render(){this.container.empty(),this.labelEl=this.container.createSpan({cls:"claudian-permission-label"}),this.toggleEl=this.container.createDiv({cls:"claudian-toggle-switch"}),this.updateDisplay(),this.toggleEl.addEventListener("click",()=>this.toggle())}updateDisplay(){if(!this.toggleEl||!this.labelEl)return;let e=this.plugin.settings.permissionMode==="yolo";e?this.toggleEl.addClass("active"):this.toggleEl.removeClass("active"),this.labelEl.setText(e?"YOLO":"Safe")}async toggle(){let t=this.plugin.settings.permissionMode==="yolo"?"safe":"yolo";this.plugin.settings.permissionMode=t,await this.plugin.saveSettings(),this.updateDisplay()}},Z=class{constructor(e,t,i){this.buttonEl=null;this.dropdownEl=null;this.plugin=t,this.onProviderChange=i,this.container=e.createDiv({cls:"claudian-model-selector"}),this.render()}render(){this.container.empty(),this.buttonEl=this.container.createDiv({cls:"claudian-model-btn"}),this.updateDisplay(),this.dropdownEl=this.container.createDiv({cls:"claudian-model-dropdown"}),this.renderOptions()}updateDisplay(){if(!this.buttonEl)return;let e=this.plugin.settings.providerType,t={anthropic:"Claude",openai:"GPT",aliyun:"Qwen"};this.buttonEl.empty(),this.buttonEl.createSpan({cls:"claudian-model-label"}).setText(t[e]||e)}renderOptions(){if(!this.dropdownEl)return;this.dropdownEl.empty();let e=this.plugin.settings.providerType,t=[{value:"anthropic",label:"Claude (Anthropic)"},{value:"openai",label:"GPT (OpenAI)"},{value:"aliyun",label:"Qwen (Aliyun)"}];for(let i of t){let s=this.dropdownEl.createDiv({cls:"claudian-model-option"});i.value===e&&s.addClass("selected"),s.createSpan({text:i.label}),s.addEventListener("click",async n=>{n.stopPropagation(),this.plugin.settings.providerType=i.value,await this.plugin.saveSettings(),this.updateDisplay(),this.renderOptions(),this.onProviderChange()})}}},ee=class{constructor(e,t){this.buttonEl=null;this.container=e.createDiv({cls:"claudian-at-btn-container"}),this.onClick=t,this.render()}render(){this.buttonEl=this.container.createDiv({cls:"claudian-at-btn",text:"@"}),this.buttonEl.setAttribute("title","Add context"),this.buttonEl.addEventListener("click",e=>{e.stopPropagation(),this.onClick()})}},te=class{constructor(e){this.iconEl=null;this.badgeEl=null;this.externalContextPaths=[];this.container=e.createDiv({cls:"claudian-external-context-selector"}),this.render()}render(){this.container.empty();let e=this.container.createDiv({cls:"claudian-external-context-icon-wrapper"});this.iconEl=e.createDiv({cls:"claudian-external-context-icon"}),(0,U.setIcon)(this.iconEl,"folder"),this.badgeEl=e.createDiv({cls:"claudian-external-context-badge"}),this.updateDisplay(),e.addEventListener("click",()=>this.openFolderPicker())}async openFolderPicker(){try{let{remote:e}=require("electron"),t=await e.dialog.showOpenDialog({properties:["openDirectory"],title:"Select External Context Folder"});if(!t.canceled&&t.filePaths.length>0){let i=t.filePaths[0];this.externalContextPaths.includes(i)||(this.externalContextPaths.push(i),this.updateDisplay())}}catch(e){new U.Notice("In-browser mode: folder context unavailable")}}updateDisplay(){if(!this.badgeEl)return;let e=this.externalContextPaths.length;e>0?(this.badgeEl.setText(String(e)),this.badgeEl.show()):this.badgeEl.hide()}getExternalContexts(){return[...this.externalContextPaths]}clearExternalContexts(){this.externalContextPaths=[],this.updateDisplay()}},H=class{constructor(e,t,i){this.container=e.createDiv({cls:"claudian-input-toolbar"}),this.plugin=t,this.callbacks=i,this.render()}render(){this.container.empty(),this.externalContextSelector=new te(this.container),new ee(this.container,this.callbacks.onAtClick),this.providerSelector=new Z(this.container,this.plugin,async()=>{await this.modelSelector.validateCurrentModel(),this.modelSelector.updateDisplay(),this.modelSelector.renderOptions(),this.updateVisibility(),this.callbacks.onProviderChange()}),this.modelSelector=new Y(this.container,this.plugin,this.callbacks.onModelChange),this.thinkingSelector=new J(this.container,this.plugin),this.permissionToggle=new X(this.container,this.plugin),this.updateVisibility(),this.modelSelector.validateCurrentModel()}updateVisibility(){let e=this.plugin.settings.providerType==="anthropic",t=this.container.querySelector(".claudian-thinking-selector");t&&(t.style.display=e?"flex":"none")}getExternalContexts(){return this.externalContextSelector.getExternalContexts()}clearExternalContexts(){this.externalContextSelector.clearExternalContexts()}};var A=require("obsidian"),$=class{constructor(e,t){this.containerEl=e,this.plugin=t}renderMessages(e){this.containerEl.empty(),this.containerEl.createDiv({cls:"claudian-messages-spacer"}),e.forEach(t=>{let i=this.containerEl.createDiv({cls:`claudian-message ${t.role==="user"?"claudian-message-user":"claudian-message-assistant"}`}),s=i.createDiv({cls:"claudian-message-content"});this.renderContent(s,t.content),this.renderMessageActions(i,t.content)}),this.containerEl.scrollTop=this.containerEl.scrollHeight}renderLoading(){let e=this.containerEl.createDiv({cls:"claudian-message claudian-message-assistant"}),i=e.createDiv({cls:"claudian-message-content"}).createDiv({cls:"claudian-typing-indicator"});return i.createDiv({cls:"claudian-typing-dot"}),i.createDiv({cls:"claudian-typing-dot"}),i.createDiv({cls:"claudian-typing-dot"}),i.createDiv({cls:"claudian-typing-label"}).setText("Thinking..."),this.containerEl.scrollTop=this.containerEl.scrollHeight,e}renderMessageActions(e,t){let s=e.createDiv({cls:"claudian-message-actions"}).createDiv({cls:"claudian-message-action-btn"});(0,A.setIcon)(s,"copy");let n=s.createSpan({text:"Copy"});s.addEventListener("click",async r=>{r.preventDefault(),r.stopPropagation();try{await navigator.clipboard.writeText(t),n.setText("Copied!"),(0,A.setIcon)(s,"check"),setTimeout(()=>{n.setText("Copy"),(0,A.setIcon)(s,"copy")},2e3)}catch(o){console.error("Failed to copy message",o),n.setText("Error")}})}async renderContent(e,t){e.empty();let i=new A.Component;try{await A.MarkdownRenderer.renderMarkdown(t,e,"",i)}catch(n){console.error("Markdown render failed",n),e.setText(t);return}e.querySelectorAll("pre").forEach(n=>{var g;if((g=n.parentElement)!=null&&g.classList.contains("claudian-code-wrapper"))return;let r=document.createElement("div");r.className="claudian-code-wrapper",n.parentElement&&(n.parentElement.insertBefore(r,n),r.appendChild(n));let o=n.querySelector('code[class*="language-"]');if(o){let d=o.className.match(/language-([\w\d\+\-\#]+)/);if(d){r.classList.add("has-language");let p=document.createElement("span");p.className="claudian-code-lang-label",p.textContent=d[1],r.appendChild(p),p.addEventListener("click",async u=>{u.preventDefault(),u.stopPropagation();let y=o.textContent||"";try{await navigator.clipboard.writeText(y);let C=p.textContent;p.textContent="copied!",p.style.color="var(--text-success)",setTimeout(()=>{p.textContent=C,p.style.color=""},1500)}catch(C){console.error("Failed to copy",C)}})}}let l=n.querySelector(".copy-code-button");l&&r&&r.appendChild(l)})}};var S=require("obsidian"),N=class extends S.FuzzySuggestModal{constructor(e,t){super(e),this.onSelect=t,this.setPlaceholder("Select a file to add to context...")}getItems(){return this.app.vault.getFiles().filter(e=>e.extension==="md")}getItemText(e){return e.path}onChooseItem(e,t){this.onSelect(e)}},_=class{constructor(e,t,i){this.activeFile=null;this.manualFiles=new Set;this.app=e,this.container=t,this.onUpdate=i}setActiveFile(e){this.activeFile=e,this.render(),this.onUpdate()}addManualFile(e){if(this.manualFiles.has(e)){new S.Notice("File already added to context");return}if(this.activeFile===e){new S.Notice("File is already the active Active Note");return}this.manualFiles.add(e),this.render(),this.onUpdate()}removeManualFile(e){this.manualFiles.delete(e),this.render(),this.onUpdate()}clearManualFiles(){this.manualFiles.clear(),this.render(),this.onUpdate()}clearAll(){this.manualFiles.clear(),this.render(),this.onUpdate()}hasFiles(){return this.activeFile!==null||this.manualFiles.size>0}render(){if(this.container.empty(),!this.activeFile&&this.manualFiles.size===0){this.container.style.display="none";return}else this.container.style.display="flex";this.activeFile&&this.renderChip(this.activeFile,"active"),this.manualFiles.forEach(e=>{e!==this.activeFile&&this.renderChip(e,"manual")})}renderChip(e,t){let i=this.container.createDiv({cls:`claudian-file-chip ${t==="active"?"claudian-chip-active":""}`}),s=i.createSpan({cls:"claudian-file-chip-icon"});(0,S.setIcon)(s,t==="active"?"eye":"file-text");let n=t==="active"?`Current: ${e.basename}`:e.basename;if(i.createSpan({text:n,cls:"claudian-file-chip-text"}),t==="manual"){let r=i.createDiv({cls:"claudian-file-chip-remove"});(0,S.setIcon)(r,"x"),r.onclick=o=>{o.stopPropagation(),this.removeManualFile(e)}}}async getContextString(){let e=new Set;if(this.activeFile&&e.add(this.activeFile),this.manualFiles.forEach(i=>e.add(i)),e.size===0)return"";let t=`
<context_files>
`;for(let i of e)try{let s=await this.app.vault.read(i),n=i===this.activeFile;t+=`<file path="${i.path}" ${n?'current="true"':""}>
${s}
</file>
`}catch(s){console.error(`Failed to read file ${i.path}`,s)}return t+=`</context_files>
`,t}};var m=[];for(let a=0;a<256;++a)m.push((a+256).toString(16).slice(1));function de(a,e=0){return(m[a[e+0]]+m[a[e+1]]+m[a[e+2]]+m[a[e+3]]+"-"+m[a[e+4]]+m[a[e+5]]+"-"+m[a[e+6]]+m[a[e+7]]+"-"+m[a[e+8]]+m[a[e+9]]+"-"+m[a[e+10]]+m[a[e+11]]+m[a[e+12]]+m[a[e+13]]+m[a[e+14]]+m[a[e+15]]).toLowerCase()}var ue=require("node:crypto"),K=new Uint8Array(256),B=K.length;function ie(){return B>K.length-16&&((0,ue.randomFillSync)(K),B=0),K.slice(B,B+=16)}var he=require("node:crypto"),se={randomUUID:he.randomUUID};function Se(a,e,t){var s,n,r;a=a||{};let i=(r=(n=a.random)!=null?n:(s=a.rng)==null?void 0:s.call(a))!=null?r:ie();if(i.length<16)throw new Error("Random bytes length must be >= 16");if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[t+o]=i[o];return e}return de(i)}function Pe(a,e,t){return se.randomUUID&&!e&&!a?se.randomUUID():Se(a,e,t)}var G=Pe;var D="claudian-ext-view",k={viewBox:"0 -.01 39.5 39.53",width:"18",height:"18",path:"m7.75 26.27 7.77-4.36.13-.38-.13-.21h-.38l-1.3-.08-4.44-.12-3.85-.16-3.73-.2-.94-.2-.88-1.16.09-.58.79-.53 1.13.1 2.5.17 3.75.26 2.72.16 4.03.42h.64l.09-.26-.22-.16-.17-.16-3.88-2.63-4.2-2.78-2.2-1.6-1.19-.81-.6-.76-.26-1.66 1.08-1.19 1.45.1.37.1 1.47 1.13 3.14 2.43 4.1 3.02.6.5.24-.17.03-.12-.27-.45-2.23-4.03-2.38-4.1-1.06-1.7-.28-1.02c-.1-.42-.17-.77-.17-1.2l1.23-1.67.68-.22 1.64.22.69.6 1.02 2.33 1.65 3.67 2.56 4.99.75 1.48.4 1.37.15.42h.26v-.24l.21-2.81.39-3.45.38-4.44.13-1.25.62-1.5 1.23-.81.96.46.79 1.13-.11.73-.47 3.05-.92 4.78-.6 3.2h.35l.4-.4 1.62-2.15 2.72-3.4 1.2-1.35 1.4-1.49.9-.71h1.7l1.25 1.86-.56 1.92-1.75 2.22-1.45 1.88-2.08 2.8-1.3 2.24.12.18.31-.03 4.7-1 2.54-.46 3.03-.52 1.37.64.15.65-.54 1.33-3.24.8-3.8.76-5.66 1.34-.07.05.08.1 2.55.24 1.09.06h2.67l4.97.37 1.3.86.78 1.05-.13.8-2 1.02-2.7-.64-6.3-1.5-2.16-.54h-.3v.18l1.8 1.76 3.3 2.98 4.13 3.84.21.95-.53.75-.56-.08-3.63-2.73-1.4-1.23-3.17-2.67h-.21v.28l.73 1.07 3.86 5.8.2 1.78-.28.58-1 .35-1.1-.2-2.26-3.17-2.33-3.57-1.88-3.2-.23.13-1.11 11.95-.52.61-1.2.46-1-.76-.53-1.23.53-2.43.64-3.17.52-2.52.47-3.13.28-1.04-.02-.07-.23.03-2.36 3.24-3.59 4.85-2.84 3.04-.68.27-1.18-.61.11-1.09.66-.97 3.93-5 2.37-3.1 1.53-1.79-.01-.26h-.09l-10.44 6.78-1.86.24-.8-.75.1-1.23.38-.4 3.14-2.16z",fill:"currentColor"},ne=class extends w.FuzzySuggestModal{constructor(e,t,i){super(e),this.sessions=t,this.onSelect=i,this.setPlaceholder("Search history...")}getItems(){return this.sessions.sort((e,t)=>t.timestamp-e.timestamp)}getItemText(e){let t=new Date(e.timestamp).toLocaleString();return`${e.title} (${t})`}onChooseItem(e,t){this.onSelect(e)}},R=class extends w.ItemView{constructor(t,i){super(t);this.messages=[];this.inputEl=null;this.isLoading=!1;this.plugin=i,this.currentSessionId=G()}getViewType(){return D}getDisplayText(){return"Opensidian"}getIcon(){return"bot"}async onOpen(){let t=this.containerEl.children[1];t.empty(),t.addClass("claudian-container"),this.updateTheme();let i=t.createDiv({cls:"claudian-header"});this.buildHeader(i),this.messagesEl=t.createDiv({cls:"claudian-messages"}),this.welcomeEl=this.messagesEl.createDiv({cls:"claudian-welcome"}),this.renderWelcome(),this.messageRenderer=new $(this.messagesEl,this.plugin);let s=t.createDiv({cls:"claudian-input-container"});this.buildInputArea(s),this.registerEvent(this.app.workspace.on("active-leaf-change",n=>{(n==null?void 0:n.view.getViewType())!==D&&this.updateActiveFileContext()})),this.updateActiveFileContext()}updateActiveFileContext(){let t=this.app.workspace.getActiveFile();t&&this.fileContextManager.setActiveFile(t)}updateTheme(){let t=this.containerEl.children[1];t&&t.setAttribute("data-provider",this.plugin.settings.providerType)}buildHeader(t){let i=t.createDiv({cls:"claudian-title"}),s=i.createSpan({cls:"claudian-logo"}),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttribute("viewBox",k.viewBox),n.setAttribute("width",k.width),n.setAttribute("height",k.height),n.setAttribute("fill","none"),n.style.color="var(--claudian-accent)";let r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("d",k.path),r.setAttribute("fill",k.fill),n.appendChild(r),s.appendChild(n),i.createEl("h4",{text:"Opensidian"});let o=t.createDiv({cls:"claudian-header-actions"}),l=o.createDiv({cls:"claudian-header-btn"});(0,w.setIcon)(l,"plus"),l.setAttribute("title","New Chat"),l.onclick=()=>this.newChat();let g=o.createDiv({cls:"claudian-header-btn"});(0,w.setIcon)(g,"history"),g.setAttribute("title","Chat History"),g.onclick=()=>this.showHistory()}renderWelcome(){this.welcomeEl.empty(),this.welcomeEl.createDiv({cls:"claudian-welcome-greeting"}).setText(`Good ${this.getTimeOfDay()}, ${this.plugin.settings.username}`),this.welcomeEl.createDiv({cls:"claudian-welcome-subtitle"}).setText("How can I help you today?");let s=this.welcomeEl.createDiv({cls:"claudian-suggestions"}),n=[{icon:"pencil",title:"Help me write",desc:"Draft content for a note or article",prompt:"Help me write a note about "},{icon:"file-text",title:"Summarize",desc:"Summarize current document",prompt:"Please summarize the current document."},{icon:"layout-list",title:"Plan",desc:"Create a template or plan",prompt:"Create a daily journal template."}];for(let r of n){let o=s.createDiv({cls:"claudian-suggestion"}),l=o.createDiv({cls:"claudian-suggestion-icon"});(0,w.setIcon)(l,r.icon),o.createDiv({cls:"claudian-suggestion-title",text:r.title}),o.createDiv({cls:"claudian-suggestion-desc",text:r.desc}),o.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),this.inputEl&&(this.inputEl.value=r.prompt,this.inputEl.focus(),this.inputEl.style.height="auto",this.inputEl.style.height=Math.min(this.inputEl.scrollHeight,200)+"px")})}}getTimeOfDay(){let t=new Date().getHours();return t<12?"morning":t<18?"afternoon":"evening"}buildInputArea(t){let i=t.createDiv({cls:"claudian-input-wrapper"});this.contextIndicatorEl=i.createDiv({cls:"claudian-context-indicator"}),this.contextIndicatorEl.style.display="none",this.fileContextManager=new _(this.app,this.contextIndicatorEl,()=>{}),this.updateActiveFileContext(),this.inputEl=i.createEl("textarea",{cls:"claudian-input",placeholder:"Message Opensidian...",attr:{rows:"1"}}),this.inputEl.addEventListener("input",()=>{this.inputEl&&(this.inputEl.style.height="auto",this.inputEl.style.height=Math.min(this.inputEl.scrollHeight,200)+"px")}),this.inputEl.addEventListener("keydown",r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),this.sendMessage())});let s=i.createDiv({cls:"claudian-input-footer"});this.inputToolbar=new H(s,this.plugin,{onProviderChange:()=>{this.updateTheme()},onModelChange:()=>{},onAtClick:()=>this.handleAtClick()});let n=s.createDiv({cls:"claudian-send-btn"});(0,w.setIcon)(n,"send"),n.onclick=()=>this.sendMessage()}handleAtClick(){new N(this.app,t=>{var i;this.fileContextManager.addManualFile(t),(i=this.inputEl)==null||i.focus()}).open()}async loadHistory(){let t=await this.plugin.loadData();return(t==null?void 0:t.history)||{sessions:[]}}async saveHistory(t){let i=await this.plugin.loadData()||{},s=i.history||{sessions:[]},n=s.sessions.findIndex(r=>r.id===t.id);n>=0?s.sessions[n]=t:s.sessions.push(t),i.history=s,await this.plugin.saveData(i)}async showHistory(){let t=await this.loadHistory();if(t.sessions.length===0){new w.Notice("No history found");return}new ne(this.app,t.sessions,i=>{this.restoreSession(i)}).open()}restoreSession(t){this.currentSessionId=t.id,this.messages=t.messages,this.welcomeEl.hide(),this.messagesEl.empty(),this.welcomeEl=this.messagesEl.createDiv({cls:"claudian-welcome"}),this.welcomeEl.hide(),this.messageRenderer.renderMessages(this.messages),this.fileContextManager.clearManualFiles()}newChat(){this.currentSessionId=G(),this.messages=[],this.messagesEl.empty(),this.welcomeEl=this.messagesEl.createDiv({cls:"claudian-welcome"}),this.renderWelcome(),this.inputToolbar.clearExternalContexts(),this.fileContextManager.clearAll(),this.updateActiveFileContext(),this.inputEl&&(this.inputEl.value="",this.inputEl.style.height="auto",this.inputEl.focus())}async sendMessage(){if(!this.inputEl||this.isLoading)return;let t=this.inputEl.value.trim();if(!t&&!this.fileContextManager.hasFiles())return;this.inputEl.value="",this.inputEl.style.height="auto",this.isLoading=!0,this.welcomeEl.hide();let i=await this.fileContextManager.getContextString(),s=t;i&&(s=`${i}
${t}`,t||(s=i+`
(Analyze these files)`));let n={role:"user",content:t||"(Sent files)",timestamp:Date.now()};this.messages.push(n),this.messageRenderer.renderMessages(this.messages),this.updateCurrentSession();let r=this.messageRenderer.renderLoading(),o={},l=this.plugin.settings;l.anthropicApiKey&&(o.ANTHROPIC_API_KEY=l.anthropicApiKey),l.anthropicBaseUrl&&(o.ANTHROPIC_BASE_URL=l.anthropicBaseUrl);let g=this.app.vault.adapter.basePath||".";console.log("Opensidian sending:",{provider:l.providerType,model:l.modelType});try{let d=this.plugin.agentFactory.query({prompt:s,cwd:String(g),model:l.modelType,provider:l.providerType,permissionMode:l.permissionMode,env:o}),p="";for await(let y of d)if(y.type==="content")p+=y.content;else if(y.type==="error"){p=`Error: ${y.error}`;break}else if(y.type==="complete")break;r.remove();let u={role:"assistant",content:p||"No response",timestamp:Date.now()};this.messages.push(u),this.messageRenderer.renderMessages(this.messages),this.updateCurrentSession()}catch(d){r.remove();let p=d instanceof Error?d.message:String(d);this.messages.push({role:"assistant",content:`Error: ${p}`,timestamp:Date.now()}),this.messageRenderer.renderMessages(this.messages)}finally{this.isLoading=!1}}updateCurrentSession(){let t="New Chat";if(this.messages.length>0){let s=this.messages[0].content;t=s.length>30?s.substring(0,30)+"...":s}let i={id:this.currentSessionId,title:t,timestamp:Date.now(),messages:this.messages};this.saveHistory(i)}};var ge=require("obsidian"),O=class{constructor(e,t){this.baseUrl=e.replace(/\/$/,""),this.apiKey=t}async chat(e,t){let i=`${this.baseUrl}/v1/messages`,s={model:e,messages:t.map(n=>({role:n.role,content:n.content})),max_tokens:8192};try{let n=await(0,ge.requestUrl)({url:i,method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify(s)});if(n.status!==200)throw new Error(`Anthropic API Error: ${n.status} - ${n.text}`);let o=n.json.content;return Array.isArray(o)?o.filter(l=>l.type==="text").map(l=>l.text).join(""):String(o)}catch(n){throw new Error(`Anthropic API Error: ${n instanceof Error?n.message:String(n)}`)}}async*streamChat(e,t){var n,r;let i=`${this.baseUrl}/v1/messages`,s={model:e,messages:t.map(o=>({role:o.role,content:o.content})),max_tokens:8192,stream:!0};try{let o=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify(s)});if(!o.ok){let p=await o.text();throw new Error(`Anthropic API Error: ${o.status} - ${p}`)}let l=(n=o.body)==null?void 0:n.getReader();if(!l)throw new Error("No response body");let g=new TextDecoder,d="";for(;;){let{done:p,value:u}=await l.read();if(p)break;d+=g.decode(u,{stream:!0});let y=d.split(`
`);d=y.pop()||"";for(let C of y)if(C.startsWith("data: ")){let M=C.slice(6);if(M==="[DONE]"){yield{type:"complete",content:""};return}try{let f=JSON.parse(M);if(f.type==="content_block_delta"){let T=f.delta;(T==null?void 0:T.type)==="text_delta"&&T.text&&(yield{type:"content",content:T.text,isComplete:!1})}else if(f.type==="message_stop"){yield{type:"complete",content:""};return}else if(f.type==="error"){yield{type:"error",content:"",error:((r=f.error)==null?void 0:r.message)||"Unknown error"};return}}catch(f){}}}yield{type:"complete",content:""}}catch(o){yield{type:"error",content:"",error:o instanceof Error?o.message:String(o)}}}};var me=require("obsidian"),L=class{constructor(e,t){this.baseUrl=e.replace(/\/$/,""),this.apiKey=t,console.log("[OpenAIClient] v3.0 Mega-Strategy Client Initialized")}async*streamChat(e){var f,T;let t=e.model,i=(f=e.maxOutputTokens)!=null?f:2048,s=(T=e.temperature)!=null?T:.7,n=/codex/i.test(t),r=n||/^gpt-5/i.test(t)||/^o1/i.test(t),o=e.messages.find(c=>c.role==="system"),l=(o==null?void 0:o.content)||"",g=e.messages.filter(c=>c.role!=="system"),d=e.messages.map(c=>({role:c.role,content:c.content})),p=g.map(c=>({role:c.role,content:c.content})),u=[],y=(c,v,x)=>{let E=c==="fetch"?{"Content-Type":"application/json",Accept:"text/event-stream",Authorization:`Bearer ${this.apiKey}`}:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${this.apiKey}`};u.push({mode:`chat_completions_${c}${v}`,url:`${this.baseUrl}/chat/completions`,method:c,headers:E,body:{model:t,messages:d,max_tokens:i,temperature:s,stream:x}}),r&&u.push({mode:`chat_completions_${c}${v}_alt`,url:`${this.baseUrl}/chat/completions`,method:c,headers:E,body:{model:t,messages:d,max_completion_tokens:i,temperature:s,stream:x}}),u.push({mode:`chat_completions_${c}${v}_min`,url:`${this.baseUrl}/chat/completions`,method:c,headers:E,body:{model:t,messages:d,stream:x}})},C=(c,v,x)=>{let E=c==="fetch"?{"Content-Type":"application/json",Accept:"text/event-stream",Authorization:`Bearer ${this.apiKey}`}:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${this.apiKey}`},P={model:t,input:p,...l?{instructions:l}:{},stream:x};u.push({mode:`responses_${c}${v}`,url:`${this.baseUrl}/responses`,method:c,headers:E,body:{...P,max_output_tokens:i,temperature:s}}),u.push({mode:`responses_${c}${v}_min`,url:`${this.baseUrl}/responses`,method:c,headers:E,body:P})};if(y("fetch","_stream",!0),y("obsidian","_fallback",!1),n){let c=[],v=u}if(n){let c=[],v=E=>c.push(E),x=u.push;u.push=v,C("fetch","_stream",!0),C("obsidian","_fallback",!1),u.push=x,u.unshift(...c)}let M=[];for(let c of u){console.log(`[OpenAIClient] Trying ${c.mode}...`);try{if(c.method==="fetch"){yield*this.executeFetch(c);return}else{yield*this.executeObsidian(c);return}}catch(v){let x=v instanceof Error?v.message:String(v);console.warn(`[OpenAIClient] Failed ${c.mode}: ${x}`),M.push(`${c.mode}: ${x}`)}}yield{type:"error",content:"",error:`All attempts failed:
${M.join(`
`)}`}}async*executeFetch(e){var r,o,l,g,d,p,u,y,C,M;let t=await fetch(e.url,{method:"POST",headers:e.headers,body:JSON.stringify(e.body)});if(!t.ok){let f=await t.text();throw new Error(`HTTP ${t.status} - ${f}`)}let i=(r=t.body)==null?void 0:r.getReader();if(!i)throw new Error("No response body");let s=new TextDecoder,n="";for(;;){let{done:f,value:T}=await i.read();if(f)break;n+=s.decode(T,{stream:!0});let c=n.split(`
`);n=c.pop()||"";for(let v of c)if(v.trim().startsWith("data: ")){let x=v.trim().slice(6);if(x==="[DONE]"){yield{type:"complete",content:""};return}try{let E=JSON.parse(x),P="";e.mode.includes("responses")?P=((l=(o=E.choices)==null?void 0:o[0])==null?void 0:l.text)||((u=(p=(d=(g=E.output)==null?void 0:g[0])==null?void 0:d.content)==null?void 0:p[0])==null?void 0:u.text)||"":P=((M=(C=(y=E.choices)==null?void 0:y[0])==null?void 0:C.delta)==null?void 0:M.content)||"",P&&(yield{type:"content",content:P,isComplete:!1})}catch(E){}}}yield{type:"complete",content:""}}async*executeObsidian(e){var n,r,o,l,g,d,p;let t=await(0,me.requestUrl)({url:e.url,method:"POST",headers:e.headers,body:JSON.stringify(e.body),throw:!1});if(t.status>=300)throw new Error(`HTTP ${t.status} - ${t.text}`);let i=t.json,s="";if(e.mode.includes("responses")?s=((l=(o=(r=(n=i==null?void 0:i.output)==null?void 0:n[0])==null?void 0:r.content)==null?void 0:o[0])==null?void 0:l.text)||(i==null?void 0:i.output)||"":s=((p=(d=(g=i==null?void 0:i.choices)==null?void 0:g[0])==null?void 0:d.message)==null?void 0:p.content)||"",!s&&typeof t.text=="string"){let u=t.text;u&&!i&&(s=u)}s&&(yield{type:"content",content:s,isComplete:!0}),yield{type:"complete",content:""}}};var V=class{constructor(e){this.openaiClient=null;this.anthropicClient=null;this.settings=e,this.initClients()}updateSettings(e){this.settings=e,this.initClients()}initClients(){this.settings.openaiApiKey&&this.settings.openaiBaseUrl&&(this.openaiClient=new L(this.settings.openaiBaseUrl,this.settings.openaiApiKey)),this.settings.anthropicApiKey&&this.settings.anthropicBaseUrl&&(this.anthropicClient=new O(this.settings.anthropicBaseUrl,this.settings.anthropicApiKey))}async*query(e){let{prompt:t,model:i,provider:s}=e;s==="openai"&&this.openaiClient&&le(i)?yield*this.openAIQuery(t,i):s==="aliyun"?yield*this.aliyunQuery(t,i):yield*this.anthropicQuery(t,i)}async*anthropicQuery(e,t){if(!this.anthropicClient)if(this.settings.anthropicApiKey&&this.settings.anthropicBaseUrl)this.anthropicClient=new O(this.settings.anthropicBaseUrl,this.settings.anthropicApiKey);else{yield{type:"error",content:"",error:"Anthropic API key not configured. Please set it in Settings > Opensidian."};return}let i=ce(t,"anthropic"),s=[{role:"user",content:e}];try{let n=this.anthropicClient.streamChat(i,s);for await(let r of n)yield r}catch(n){yield{type:"error",content:"",error:n instanceof Error?n.message:String(n)}}}async*aliyunQuery(e,t){let i=this.settings.aliyunApiKey,s=this.settings.aliyunBaseUrl;if(!i){yield{type:"error",content:"",error:"Aliyun API key not configured"};return}let n=new L(s,i),r=[{role:"user",content:e}];try{let o=n.streamChat({model:t,messages:r});for await(let l of o)yield l}catch(o){yield{type:"error",content:"",error:o instanceof Error?o.message:String(o)}}}async*openAIQuery(e,t){if(!this.openaiClient){yield{type:"error",content:"",error:"OpenAI client not initialized"};return}let i=[{role:"user",content:e}];try{let s=this.openaiClient.streamChat({model:t,messages:i});for await(let n of s)yield n}catch(s){yield{type:"error",content:"",error:s instanceof Error?s.message:String(s)}}}};var ye={providerType:"anthropic",anthropicBaseUrl:"https://api.anthropic.com",anthropicApiKey:"",openaiBaseUrl:"https://api.openai.com/v1",openaiApiKey:"",aliyunBaseUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",aliyunApiKey:"",modelType:"haiku",customModelId:"",customAliyunModels:"",customAnthropicModels:"",customOpenAIModels:"",thinkingBudget:"off",permissionMode:"yolo",username:"User",autoTitle:!0,enableBlocklist:!0,claudeCliPath:""};var h=require("obsidian");var j=W(require("fs")),I=W(require("os")),b=W(require("path"));function De(a){return a==="~"?I.homedir():a.startsWith("~/")?b.join(I.homedir(),a.slice(2)):a.startsWith("~\\")?b.join(I.homedir(),a.slice(2)):a}function ae(a){try{if(j.existsSync(a))return j.statSync(a).isFile()}catch(e){}return!1}function ve(a){let e=I.homedir(),t=process.platform==="win32";if(a){let o=De(a.trim());if(ae(o))return o}let i=[];t?i.push(b.join(e,".claude","local","claude.exe"),b.join(e,"AppData","Local","Claude","claude.exe"),b.join(process.env.ProgramFiles||"C:\\Program Files","Claude","claude.exe"),b.join(e,"AppData","Roaming","npm","node_modules","@anthropic-ai","claude-code","cli.js")):i.push(b.join(e,".claude","local","claude"),b.join(e,".local","bin","claude"),"/usr/local/bin/claude","/opt/homebrew/bin/claude",b.join(e,".npm-global","lib","node_modules","@anthropic-ai","claude-code","cli.js"),"/usr/local/lib/node_modules/@anthropic-ai/claude-code/cli.js","/usr/lib/node_modules/@anthropic-ai/claude-code/cli.js");for(let o of i)if(ae(o))return o;let s=process.env.PATH||"",n=t?";":":",r=s.split(n);for(let o of r){if(!o)continue;let l=t?["claude.exe","claude"]:["claude"];for(let g of l){let d=b.join(o,g);if(ae(d))return d}}return null}var q=class extends h.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Opensidian Settings"}),new h.Setting(e).setName("General").setHeading(),new h.Setting(e).setName("User Name").setDesc("How should the AI address you?").addText(s=>s.setPlaceholder("User").setValue(this.plugin.settings.username).onChange(async n=>{this.plugin.settings.username=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Default Provider").setDesc("Which provider to use by default").addDropdown(s=>s.addOption("anthropic","Claude (Anthropic)").addOption("openai","GPT (OpenAI)").addOption("aliyun","Qwen (Aliyun)").setValue(this.plugin.settings.providerType).onChange(async n=>{this.plugin.settings.providerType=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Default Model").setDesc("Which model to use by default").addDropdown(s=>{s.addOption("haiku","Claude Haiku"),s.addOption("sonnet","Claude Sonnet"),s.addOption("opus","Claude Opus"),s.addOption("gpt-5.2","GPT-5.2"),s.addOption("gpt-5-codex","GPT-5 Codex"),s.addOption("qwen-turbo","Qwen Turbo"),s.addOption("qwen-plus","Qwen Plus"),s.addOption("qwen-max","Qwen Max"),s.setValue(this.plugin.settings.modelType).onChange(async n=>{this.plugin.settings.modelType=n,await this.plugin.saveSettings()})}),new h.Setting(e).setName("Permission Mode").setDesc("YOLO = auto-approve all actions, Safe = ask before actions").addDropdown(s=>s.addOption("yolo","YOLO (Auto-approve)").addOption("safe","Safe (Ask before)").setValue(this.plugin.settings.permissionMode).onChange(async n=>{this.plugin.settings.permissionMode=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Thinking Budget").setDesc("How much thinking time to allow (Claude only)").addDropdown(s=>s.addOption("off","Off").addOption("low","Low (1k tokens)").addOption("medium","Medium (4k tokens)").addOption("high","High (16k tokens)").addOption("max","Max (32k tokens)").setValue(this.plugin.settings.thinkingBudget).onChange(async n=>{this.plugin.settings.thinkingBudget=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Claude SDK (Advanced)").setHeading();let t=new h.Setting(e).setName("Claude CLI Path").setDesc("Path to Claude CLI executable. Leave empty for auto-detect."),i=ve();i?t.setDesc(`Auto-detected: ${i}. Override if needed.`):t.setDesc("\u26A0\uFE0F Claude CLI not found. Install it or set path manually."),t.addText(s=>s.setPlaceholder("/usr/local/bin/claude").setValue(this.plugin.settings.claudeCliPath).onChange(async n=>{this.plugin.settings.claudeCliPath=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Anthropic (Claude)").setHeading(),new h.Setting(e).setName("API Key").setDesc("Your Anthropic API key").addText(s=>s.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async n=>{this.plugin.settings.anthropicApiKey=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Base URL").setDesc("Optional API proxy URL").addText(s=>s.setPlaceholder("https://api.anthropic.com").setValue(this.plugin.settings.anthropicBaseUrl).onChange(async n=>{this.plugin.settings.anthropicBaseUrl=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Custom Claude Models").setDesc("Add custom Claude model IDs, separated by commas or newlines").addTextArea(s=>s.setPlaceholder("claude-3-opus-20240229").setValue(this.plugin.settings.customAnthropicModels).onChange(async n=>{this.plugin.settings.customAnthropicModels=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("OpenAI / Compatible").setHeading(),new h.Setting(e).setName("API Key").setDesc("Your OpenAI API key").addText(s=>s.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async n=>{this.plugin.settings.openaiApiKey=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Base URL").setDesc("API endpoint (e.g. https://api.openai.com/v1)").addText(s=>s.setPlaceholder("https://api.openai.com/v1").setValue(this.plugin.settings.openaiBaseUrl).onChange(async n=>{this.plugin.settings.openaiBaseUrl=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Custom GPT Models").setDesc("Add custom OpenAI model IDs, separated by commas or newlines").addTextArea(s=>s.setPlaceholder(`gpt-4o
gpt-4-turbo`).setValue(this.plugin.settings.customOpenAIModels).onChange(async n=>{this.plugin.settings.customOpenAIModels=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Aliyun (Qwen)").setHeading(),new h.Setting(e).setName("API Key").setDesc("Your Aliyun DashScope API key").addText(s=>s.setPlaceholder("sk-...").setValue(this.plugin.settings.aliyunApiKey).onChange(async n=>{this.plugin.settings.aliyunApiKey=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Base URL").setDesc("DashScope compatible endpoint").addText(s=>s.setPlaceholder("https://dashscope.aliyuncs.com/compatible-mode/v1").setValue(this.plugin.settings.aliyunBaseUrl).onChange(async n=>{this.plugin.settings.aliyunBaseUrl=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("Custom Qwen Models").setDesc("Add custom Aliyun model IDs, separated by commas or newlines").addTextArea(s=>s.setPlaceholder(`qwen-long
qwen-coder-plus`).setValue(this.plugin.settings.customAliyunModels).onChange(async n=>{this.plugin.settings.customAliyunModels=n,await this.plugin.saveSettings()})),new h.Setting(e).setName("About").setHeading(),e.createEl("p",{text:"Opensidian - A multi-provider AI assistant for Obsidian.",cls:"setting-item-description"})}};var z=class extends fe.Plugin{constructor(){super(...arguments);this.view=null}async onload(){console.log("Opensidian loaded"),await this.loadSettings(),this.addSettingTab(new q(this.app,this)),this.agentFactory=new V(this.settings),this.registerView(D,t=>this.view=new R(t,this)),this.addRibbonIcon("bot","Open Opensidian",()=>{this.activateView()}),this.addCommand({id:"open-chat",name:"Open Chat",callback:()=>this.activateView()})}onunload(){console.log("Claudian Extension unloaded"),this.app.workspace.detachLeavesOfType(D)}async loadSettings(){this.settings=Object.assign({},ye,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.agentFactory.updateSettings(this.settings)}async activateView(){let t=this.app.workspace.getLeavesOfType(D);if(t.length>0){this.app.workspace.revealLeaf(t[0]);return}let i=this.app.workspace.getRightLeaf(!1);i&&(await i.setViewState({type:D,active:!0}),this.app.workspace.revealLeaf(i))}};
